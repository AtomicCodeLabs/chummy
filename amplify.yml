version: 1
applications:
  - appRoot: extension
    env:
      variables:
        VERSION: 1.0.0
        ASSETS_PUBLIC_PATH: $ASSETS_PUBLIC_PATH
        WEBSITE_BASE_URL: $WEBSITE_BASE_URL
        WEBSITE_SIGNIN: $WEBSITE_SIGNIN
        WEBSITE_REDIRECT: $WEBSITE_REDIRECT
    backend:
      phases:
        build:
          commands:
            - amplifyPush --simple
    frontend:
      phases:
        preBuild:
          commands:
            - echo $KEY_PEM > ./key.pem
            - yarn install --frozen-lockfile
            - yarn lint:check
            - yarn format:check
        build:
          commands:
            - yarn build:moz
            - yarn build:web
      artifacts:
        files:
          - "**/*"
        discard-paths: yes
        baseDirectory: dist
      cache:
        paths:
          - node_modules/**/*
    test:
      phases:
        preTest:
          commands:
            - echo "Prepublish CDN assets to S3"
            - echo $VERSION
            - yarn add -D wait-on
            - yarn add -D mocha@5.2.0 mochawesome mochawesome-merge mochawesome-report-generator
            - npx wait-on http://localhost:8080
            - yarn ci:prepublish
        test:
          commands:
            - 'yarn cy:run:moz --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"'
            - 'yarn cy:run:web --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"'
        postTest:
          commands:
            - npx mochawesome-merge cypress/report/mochawesome-report/mochawesome*.json > cypress/report/mochawesome.json
            - echo "Publish `dist` assets to S3"
            - yarn ci:publish
      artifacts:
        files:
          - "**/*.png"
          - "**/*.mp4"
        baseDirectory: cypress
        configFilePath: '**/mochawesome.json'
    artifacts:
      files:
        - "**/*"
      baseDirectory: dist
