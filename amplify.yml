version: 1
applications:
  - appRoot: extension
    env:
      variables:
        VERSION: 1.0.0
        ASSETS_PUBLIC_PATH: $ASSETS_PUBLIC_PATH
        WEBSITE_BASE_URL: $WEBSITE_BASE_URL
        WEBSITE_SIGNIN: $WEBSITE_SIGNIN
        WEBSITE_REDIRECT: $WEBSITE_REDIRECT
    backend:
      phases:
        build:
          commands:
            - amplifyPush --simple
    frontend:
      phases:
        preBuild:
          commands:
            - echo $KEY_PEM > ./key.pem
            - yarn install --frozen-lockfile
            - yarn lint:check
            - yarn format:check
        build:
          commands:
            - yarn build:moz
            - yarn build:web
      artifacts:
        files:
          - "**/*"
        discard-paths: yes
        baseDirectory: dist
      cache:
        paths:
          - node_modules/**/*
    test:
      phases:
        preTest:
          commands:
            - wget -O- "https://download.mozilla.org/?product=firefox-latest-ssl&os=linux64&lang=en-US" | tar -jx -C /usr/local/
            - echo "exclude=firefox" >> /etc/dnf/dnf.conf
            - ln -s /usr/local/firefox/firefox /usr/bin/firefox
            - echo "Prepublish CDN assets to S3"
            - if [ "${AWS_BRANCH}" = "extension/gamma" ]; then yarn ci:prepublish gamma; fi
            - if [ "${AWS_BRANCH}" = "extension/prod" ]; then yarn ci:prepublish prod; fi
        test:
          commands:
            - yarn cy:run:moz
            - yarn cy:run:web
        postTest:
          commands:
            - echo "Publish `dist` assets to S3"
            - if [ "${AWS_BRANCH}" = "extension/gamma" ]; then yarn ci:publish gamma; fi
            - if [ "${AWS_BRANCH}" = "extension/prod" ]; then yarn ci:publish prod; fi
      artifacts:
        files:
          - "**/*.png"
          - "**/*.mp4"
        baseDirectory: cypress
    artifacts:
      files:
        - "**/*"
      baseDirectory: dist
