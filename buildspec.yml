version: 0.2

env:
  variables:
    WEBSITE_SIGNIN: "signin/"
    WEBSITE_REDIRECT: "account/"
    REACTCONFIG: "{\
      \"SourceDir\":\"src\",\
      \"DistributionDir\":\"dist\",\
      \"BuildCommand\":\"yarn build:web\",\
      \"StartCommand\":\"yarn dev\"\
      }"
    AWSCLOUDFORMATIONCONFIG: "{\
      \"configLevel\":\"project\",\
      \"useProfile\":true,\
      \"profileName\":\"default\"\
      }"
    AMPLIFY: "{\
      \"projectName\":\"chummy\",\
      \"appId\":\"d37x99ddsw850\",\
      \"envName\":\"$STAGE\",\
      \"defaultEditor\":\"code\"\
      }"
    FRONTEND: "{\
      \"frontend\":\"javascript\",\
      \"framework\":\"react\",\
      \"config\":$REACTCONFIG\
      }"
    PROVIDERS: "{\
      \"awscloudformation\":$AWSCLOUDFORMATIONCONFIG\
      }"

proxy:
  upload-artifacts: no
  logs: no

phases:
  pre_build:
    commands:
      - cd extension
      - echo "$STAGE"
      - echo "$AWSCLOUDFORMATIONCONFIG"
      - echo "$AMPLIFY"
      - echo "$FRONTEND"
      - echo "$PROVIDERS"
      - amplify init --amplify $AMPLIFY --frontend $FRONTEND --providers $PROVIDERS --yes
      - echo $CHUMMY_KEY_PEM > ./key.pem
      - yarn install --frozen-lockfile
      - yarn lint:check
      - yarn format:check
  build:
    commands:
      - yarn build:moz
      - yarn build:web

artifacts:
  base-directory: "extension/dist"
  files:
    - "**/*"
  secondary-artifacts:
    artifact1:
      files:
        - "moz/*"
      name: dist.moz
    artifact2:
      files:
        - "web/*"
      name: dist.web

cache:
  paths:
    - "extension/node_modules/**/*"
