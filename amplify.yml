version: 1
applications:
  - appRoot: extension
    env:
      variables:
        VERSION: 1.0.0
        ASSETS_PUBLIC_PATH: $ASSETS_PUBLIC_PATH
        WEBSITE_BASE_URL: $WEBSITE_BASE_URL
        WEBSITE_SIGNIN: $WEBSITE_SIGNIN
        WEBSITE_REDIRECT: $WEBSITE_REDIRECT
    backend:
      phases:
        build:
          commands:
            - amplifyPush --simple
    frontend:
      phases:
        preBuild:
          commands:
            - echo $KEY_PEM > ./key.pem
            - yarn install --frozen-lockfile
            - yarn lint:check
            - yarn format:check
        build:
          commands:
            - yarn build:moz
            - yarn build:web
      artifacts:
        files:
          - "**/*"
        discard-paths: yes
        baseDirectory: dist
      cache:
        paths:
          - node_modules/**/*
    test:
      phases:
        preTest:
          commands:
            - echo "Prepublish CDN assets to S3"
            - echo $VERSION
            - yarn ci:prepublish
        test:
          commands:
            - yarn cy:run:moz
            - yarn cy:run:web
        postTest:
          commands:
            - echo "Publish `dist` assets to S3"
            - yarn ci:publish
      artifacts:
        files:
          - "**/*.png"
          - "**/*.mp4"
        baseDirectory: cypress
    artifacts:
      files:
        - "**/*"
      baseDirectory: dist
