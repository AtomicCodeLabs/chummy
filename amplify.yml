version: 1
applications:
  - appRoot: website
    env:
      variables:
        VERSION: "1.0.0"
        WEBSITE_BASE_URL: $WEBSITE_BASE_URL
        WEBSITE_SIGNIN: $WEBSITE_SIGNIN
        WEBSITE_REDIRECT: $WEBSITE_REDIRECT
        STRIPE_PUBLISHABLE_KEY: $STRIPE_PUBLISHABLE_KEY
        STRIPE_SECRET_KEY: $STRIPE_SECRET_KEY
        STAGE: $STAGE
        EMAILJS_SERVICE_ID: $EMAILJS_SERVICE_ID
        EMAILJS_TEMPLATE_ID: $EMAILJS_TEMPLATE_ID
        EMAILJS_USER_ID: $EMAILJS_USER_ID
        ROOT_ACCESS_KEY_ID: $ROOT_ACCESS_KEY_ID
        ROOT_SECRET_ACCESS_KEY: $ROOT_SECRET_ACCESS_KEY
    backend:
      phases:
        build:
          commands:
            - amplifyPush --simple
    frontend:
      phases:
        preBuild:
          commands:
            - yarn install
            - REACTCONFIG="{\"SourceDir\":\"src\",\"DistributionDir\":\"dist\",\"BuildCommand\":\"yarn build:web\",\"StartCommand\":\"yarn dev\"}"
            - AWSCLOUDFORMATIONCONFIG="{\"configLevel\":\"project\",\"useProfile\":false,\"profileName\":\"default\",\"accessKeyId\":\"$ROOT_ACCESS_KEY_ID\",\"secretAccessKey\":\"$ROOT_SECRET_ACCESS_KEY\",\"region\":\"$AWS_DEFAULT_REGION\"}"
            - AMPLIFY="{\"projectName\":\"chummy\",\"appId\":\"d37x99ddsw850\",\"envName\":\"$STAGE\",\"defaultEditor\":\"code\"}"
            - FRONTEND="{\"frontend\":\"javascript\",\"framework\":\"react\",\"config\":$REACTCONFIG}"
            - PROVIDERS="{\"awscloudformation\":$AWSCLOUDFORMATIONCONFIG}"
            - amplify init --amplify $AMPLIFY --frontend $FRONTEND --providers $PROVIDERS --yes
        build:
          commands:
            - yarn build
      artifacts:
        baseDirectory: public
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
